name: CI

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npx vitest run --coverage --coverageThreshold='{"global": {"lines": 90, "branches": 90}}'

  frontend:
    runs-on: ubuntu-latest
    needs: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: cd frontend && npm ci
      - name: Fetch OpenAPI schema
        env:
          NEXT_PUBLIC_API_SCHEMA_URL: ${{ secrets.NEXT_PUBLIC_API_SCHEMA_URL }}
        run: npm --prefix frontend run fetch-schema
      - name: Generate API types
        run: npm --prefix frontend run generate-types
      - name: Run frontend tests
        run: npm --prefix frontend run test

  e2e:
    runs-on: ubuntu-latest
    needs: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - name: Run Playwright tests with A11y
        run: npm run test:e2e
      - name: Check schema freshness
        env:
          NEXT_PUBLIC_API_SCHEMA_URL: ${{ secrets.NEXT_PUBLIC_API_SCHEMA_URL }}
        run: node scripts/check-schema-fresh.js
      - name: Start frontend for Lighthouse
        run: npm --prefix frontend run start &
      - name: Run Lighthouse CI
        run: npm --prefix frontend run lhci:autorun
